<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jmframework.boot.jmspringbootstarter.mapper.UserMapper">
    <sql id="Base_Column_List">
            id,
            username,
            email,
            cellphone,
            `password`,
            full_name,
            birthday,
            gender,
            gmt_created,
            gmt_modified,
            `status`
    </sql>

    <resultMap id="BaseResultMap" type="com.jmframework.boot.jmspringbootstarterdomain.user.persistence.UserPO">
        <result column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="email" property="email"/>
        <result column="cellphone" property="cellphone"/>
        <result column="password" property="password"/>
        <result column="full_name" property="fullName"/>
        <result column="birthday" property="birthday"/>
        <result column="gender" property="gender"/>
        <result column="gmt_created" property="gmtCreated"/>
        <result column="gmt_modified" property="gmtModified"/>
        <result column="status" property="status"/>
    </resultMap>

    <select id="findByUsernameOrEmailOrPhone" resultMap="BaseResultMap">
        SELECT tu.id,
               tu.username,
               tu.email,
               tu.cellphone,
               tu.password,
               tu.full_name,
               tu.birthday,
               tu.gender,
               tu.gmt_created,
               tu.gmt_modified,
               tu.status
        FROM t_user tu
        <where>
            <if test="username != null">
                tu.username = #{username}
            </if>
            <if test="email != null">
                OR tu.email = #{email}
            </if>
            <if test="phone != null">
                OR tu.cellphone = #{phone}
            </if>
        </where>
    </select>

    <select id="checkUsernameUniqueness" resultType="integer">
        SELECT count(1)
        FROM t_user tu
        WHERE tu.username = #{username}
    </select>

    <select id="checkEmailUniqueness" resultType="integer">
        SELECT count(1)
        FROM t_user tu
        WHERE tu.email = #{email}
    </select>

    <insert id="save" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_user(username,
                           email,
                           cellphone,
                           password,
                           full_name,
                           birthday,
                           gender,
                           gmt_modified,
                           gmt_created,
                           status)
        VALUES (#{username},
                #{password},
                #{cellphone},
                #{password},
                #{fullName},
                #{birthday},
                #{gender},
                now(),
                now(),
                #{status})
    </insert>

    <insert id="register" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_user(username, password, email, gmt_created, gmt_modified, status)
        VALUES (#{username}, #{password}, #{email}, now(), now(), 1)
    </insert>

    <select id="getUsernameCountByUsername" resultType="integer">
        SELECT count(1)
        FROM t_user tu
        WHERE tu.username = #{username}
    </select>

    <select id="selectUserPageList" resultMap="BaseResultMap">
        SELECT tu.id,
               tu.username,
               tu.email,
               tu.gender,
               tu.gmt_created,
               tu.gmt_modified,
               tu.status
        FROM t_user tu
    </select>

    <update id="updateUserBasicInfoById">
        UPDATE t_user
        <set>
            <if test="updated.cellphone != null ">
                cellphone = #{updated.cellphone},
            </if>
            <if test="updated.fullName != null">
                full_name = #{updated.fullName},
            </if>
            <if test="updated.birthday != null">
                birthday = #{updated.birthday},
            </if>
            gender = #{updated.gender},
            <if test="updated.status != null">
                status = #{updated.status},
            </if>
            gmt_modified = now()
        </set>
        WHERE id = #{updated.id}
    </update>

    <select id="selectByIdAndStatus" resultMap="BaseResultMap">
        SELECT id,
               username,
               email,
               cellphone,
               full_name,
               birthday,
               gender,
               status
        FROM t_user
        WHERE id = #{params.id}
          AND `status` = #{params.status}
    </select>
</mapper>
